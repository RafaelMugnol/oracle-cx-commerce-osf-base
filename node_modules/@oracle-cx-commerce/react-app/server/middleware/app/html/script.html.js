/*
 ** Copyright (c) 2021 Oracle and/or its affiliates.
 */

import {getEmptyString} from '@oracle-cx-commerce/utils/generic';
import {getSite} from '@oracle-cx-commerce/commerce-utils/selector';

export default (req, res) => {
  const {script = getEmptyString} = res.app.locals.indexHtml || {};

  const {browserCapabilities, state} = res.locals;

  const {manifests} = req.app.locals;

  const {pageTags: {head = []} = {}} = getSite(state);

  if (browserCapabilities.has('modules')) {
    // Serve modern client
    const {
      base,
      imports: {client, 'src/client.js': _client},
      preloads
    } = manifests.modern;
    let html = '';

    const buildPreloads = module => {
      if (module) {
        html += `<link rel="modulepreload" href="${base}/${module}">`;
        for (const preload of preloads[module] || []) {
          buildPreloads(preload);
        }
      }
    };

    buildPreloads(client || _client);

    html += head.join('');

    html += `<script src="${base}/${client || _client}" type="module" crossorigin></script>`;

    return html + script(req, res);
  }

  // Serve legacy client
  const {
    base,
    imports: {client, 'src/client.js': _client}
  } = manifests.legacy;

  return `${head.join(
    ''
  )}<script>window.OCC_AMD_BASE_URI = "${base}"</script><script src="https://polyfill.io/v3/polyfill.min.js?features=default,es2015,es2016,es2017,es2018,es2019" nomodule defer></script><script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@3.0.0/dist/fetch.umd.min.js" nomodule defer></script><script src="https://cdn.jsdelivr.net/npm/formdata-polyfill@3.0.18/formdata.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/babel-regenerator-runtime@6.5.0/runtime.min.js" defer></script><script src="${base}/${
    client || _client
  }" defer></script>${script(req, res)}`;
};
