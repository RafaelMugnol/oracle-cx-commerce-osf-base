/*
 ** Copyright (c) 2021 Oracle and/or its affiliates.
 */

import {getEmptyString} from '@oracle-cx-commerce/utils/generic';
import path from 'path';

/**
 * Read the web app manifest file for the current applications, i.e.
 * `<workspace>/apps/<app>/public/manifest.json`.
 *
 * @param {String} appDir The application's root directory, i.e. <workspace>/apps/<app>
 * @returns {any} The web app manifest file as json, if it exist, `undefined` otherwise.
 */
const getManifest = appDir => {
  try {
    return require(path.resolve(appDir, 'public/manifest.json'));
  } catch (error) {
    return undefined;
  }
};

/**
 * Adds PWA tags to the page during server side rendering
 */
export default (req, res) => {
  const {pwa = getEmptyString} = res.app.locals.indexHtml || {};

  const {options} = res.app.locals;
  const {publicBaseUrl = ''} = options;
  const manifest = getManifest(options.appDir);

  if (!manifest) {
    // NOT PWA
    return '';
  }

  // PWA
  return `<meta name="theme-color" content="${
    manifest['theme_color']
  }"><link rel='manifest' href="${publicBaseUrl}/manifest.json"><link rel="apple-touch-icon" href="${publicBaseUrl}/icons/apple-touch-icon.png"><script>if ('serviceWorker' in navigator) addEventListener('load',()=>navigator.serviceWorker.register('/sw.js'))</script>${pwa(
    req,
    res
  )}`;
};
