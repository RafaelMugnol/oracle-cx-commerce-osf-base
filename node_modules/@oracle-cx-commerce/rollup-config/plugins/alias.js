/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */

const path = require('path');

/*
  Substitute one module id for another when bundling. So, give the alias configuration:

  `
  {
    "react": "some-other-module"
  }
  `

  "some-other-module" will be substituted for "react" meaning "some-other-module" will be bundled instead of "react".
 */
const alias = aliases => ({
  name: 'alias',

  resolveId(importee, importer) {
    const isRelative = /^\.?\.\//;
    let aliasedImportee = aliases[importee];

    if (aliasedImportee) {
      if (!isRelative.test(aliasedImportee)) {
        /*
          require.resolve() converts a 'bare' module ids (e.g. '@oracle-cx-commerce/xxx') to an absolute path--aliases that are already relative or absolute paths should not be resolved.
         */
        aliasedImportee = require.resolve(aliasedImportee);
      } else {
        const basename = path.basename(importer);
        const directory = importer.split(basename)[0];
        aliasedImportee = path.join(directory + aliasedImportee);
      }

      return aliasedImportee;
    }
  }
});

module.exports = alias;
