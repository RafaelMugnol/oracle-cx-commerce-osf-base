/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */

const fs = require('fs-extra');
const path = require('path');

/*
  Create a manifest file for the bundle detailing some useful infomation such as entry points, logical name to filename mappings, chunk import dependencies, etc. This information is essential for rendering <script> and <link re="preload"> tags in the index.html. An (contrived) example manifest could be i.e.:

  `
  {
    "imports": {
      "client": "client-abc.js"
    },
    "preloads": {
      "client-abc.js": ["component-zyz.js"]
    }
  }
  `

  Which could be rendered in an index.html as:

  `
  <html>
    ...
    <link rel="preload" href="client-abc.js"></script> <!-- optional -->
    <script src="client-abc.js"></script>
    ...
  </html>
  `
 */
const manifest = config => ({
  name: 'manifest',

  generateBundle(options, bundle) {
    const manifest = {
      // A mapping of entry chunk names to file name.
      imports: {},
      // A mapping of entry chunk file name to dependency list [file names].
      preloads: {}
    };

    // Loop through all the chunks to detect entries.
    for (const [fileName, chunkInfo] of Object.entries(bundle)) {
      if (chunkInfo.isEntry) {
        manifest.imports[chunkInfo.name] = fileName;
      }

      if (chunkInfo.isEntry || chunkInfo.isDynamicEntry) {
        manifest.preloads[fileName] = chunkInfo.imports;
      }
    }

    fs.outputJsonSync(path.join(config.publicPath, 'manifest.json'), manifest, {spaces: 2});
  }
});

module.exports = manifest;
