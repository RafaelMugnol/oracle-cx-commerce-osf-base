/*
 ** Copyright (c) 2022 Oracle and/or its affiliates.
 */

import {getSearchResultsFetcherData} from '@oracle-cx-commerce/fetchers/search/selectors';

/**
 * Fetcher that uses the "assemblerPages" endpoint to fetch search results.
 */
export const fetchSearchResults = async (store, {searchServicePath}) => {
  const {contextId, pageId, pageType} = getSearchResultsFetcherData(store.getState());

  const payload = {
    url: pageId,
    searchServicePath
  };

  /*
   * TODO: For some reason the "dimensionId" is not included in the endpoint filter
   * "categoryNavData", which is used when fetching the category menu data. Consequently
   * a second endpoint call is required to fetch the "dimensionId". If "dimensionId"
   * were included in the "categoryNavData" filter, this call would be redundant.
   */
  if (pageType === 'category' || pageType === 'collection') {
    const response = await store.endpoint('getCollection', {
      $delta: false,
      categoryId: contextId
    });

    if (response.ok === false) {
      return response;
    }

    if (response?.json?.dimensionId) {
      payload.dimensionId = response.json.dimensionId;
    }
  }

  return store.endpoint('search', payload);
};
