/*
 ** Copyright (c) 2021 Oracle and/or its affiliates.
 */

import {APMRUM_JS_STATIC_PATH, addAPMDefaultConfig, updateUserName} from '@oracle-cx-commerce/subscribers/apm/utils';

import {getAPMSettings} from '@oracle-cx-commerce/subscribers/apm/selectors';
import {importScript} from '@oracle-cx-commerce/utils/browser';

/**
 * Subscriber that adds Application Performance Monitory agent in OSF to track page and endpoint loading time.
 *
 */
export default async ({endpoint, getState, subscribeDispatch}) => {
  // Read APM settings from extension.
  const {ociApm: apmSettings} = getAPMSettings(getState());

  if (!apmSettings || !apmSettings.enabled) {
    return;
  }

  // Import script and initialize APM settings after script is loaded.
  if (apmSettings.content && apmSettings.content.dataUploadEndpoint) {
    try {
      await importScript(apmSettings.content.dataUploadEndpoint + APMRUM_JS_STATIC_PATH);

      addAPMDefaultConfig(getState());
    } catch (error) {
      // Log loading error.
      endpoint(
        'logClientErrors',
        {message: `Failed to load ${apmSettings.content.dataUploadEndpoint}${APMRUM_JS_STATIC_PATH}`},
        getState()
      );

      return;
    }
  }

  return subscribeDispatch((action, state) => {
    const {type} = action;

    if (
      type === 'getApplicationPageComplete' ||
      type === 'initComplete' ||
      type === 'saveVisitsAndVisitorsMetricResolved'
    ) {
      updateUserName(state);
    }
  });
};
