/*
 ** Copyright (c) 2022 Oracle and/or its affiliates.
 */

import {getCurrentCatalogId, getPage, getGlobalContext} from '@oracle-cx-commerce/commerce-utils/selector';

export default ({endpoint, subscribeDispatch}) => {
  const {isPreview} = getGlobalContext(window.state);

  if (isPreview) {
    // Don't run the browsing event tracker in preview
    return;
  }

  return subscribeDispatch((action, state) => {
    const {type} = action;

    if (type === 'getApplicationPageComplete' || type === 'initComplete') {
      const {pageType, contextId} = getPage(state);

      const pageView = {};

      switch (pageType) {
        case 'product':
          pageView.type = 'PRODUCT';
          break;
        case 'category':
        case 'collection':
          pageView.type = 'COLLECTION';
          break;
        default:
      }

      // Only call the endpoint if we have a type. I.e. we're on a product or collection page.
      if (pageView.type) {
        pageView.catalogId = getCurrentCatalogId(state);

        pageView.id = contextId;

        endpoint('addBrowsingEvent', {pageView}, state);
      }
    }
  });
};
