/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */

import {getInfinitySiteSetting} from '@oracle-cx-commerce/commerce-utils/selector';
import {importScript} from '@oracle-cx-commerce/utils/browser';
import handlers from '@oracle-cx-commerce/subscribers/infinity/handlers';
import {noop} from '@oracle-cx-commerce/utils/generic';

export default ({getState, subscribeDispatch}) => {
  const {InfinityTag} = getInfinitySiteSetting(getState());
  let listener = noop;

  if (InfinityTag && InfinityTag.enabled && InfinityTag.content.url) {
    listener = (...args) => {
      for (const handler of handlers) {
        handler(...args);
      }
    };

    importScript(InfinityTag.content.url);
  }

  return subscribeDispatch(listener);
};
