/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */
import {
  getCurrentPriceListGroup,
  getCurrentOrder,
  getCurrentProfileId,
  getProduct
} from '@oracle-cx-commerce/commerce-utils/selector';
import {postToInfinity} from '@oracle-cx-commerce/subscribers/infinity/utils';

let deleteCompleteInputMap = {};

export default (action, state) => {
  const {type} = action;
  if (type === 'deleteItemFromCart') {
    const {commerceItemId} = action.payload;
    const {commerceItems} = getCurrentOrder(state);
    const {brand, type: productType} = getProduct(state, commerceItems[commerceItemId].productId);
    deleteCompleteInputMap['commerceItemId'] = commerceItemId;
    deleteCompleteInputMap['wt.dcsvid'] = getCurrentProfileId(state);
    deleteCompleteInputMap['wt.pn_id'] = commerceItems[commerceItemId].productId;
    deleteCompleteInputMap['wt.pn_sku'] = commerceItems[commerceItemId].catRefId;
    deleteCompleteInputMap['wt.tx_u'] = commerceItems[commerceItemId].quantity;
    deleteCompleteInputMap['wt.tx_s'] = commerceItems[commerceItemId].price;
    deleteCompleteInputMap['wt.pn_fa'] = productType;
    deleteCompleteInputMap['wt.pn_ma'] = brand;
    deleteCompleteInputMap['wt.tx_e'] = 'r';
    deleteCompleteInputMap['wt.z_currency'] = getCurrentPriceListGroup(state).currency.currencyCode;
  } else if (type === 'deleteItemFromCartResolved') {
    const {originalAction} = action;
    const {commerceItemId} = originalAction.payload;
    if (commerceItemId !== deleteCompleteInputMap.commerceItemId) {
      return;
    }
    delete deleteCompleteInputMap.commerceItemId;

    const inputMap = {...deleteCompleteInputMap};
    [inputMap['page-uri']] = encodeURI(window.location).split('?');
    inputMap['wt.cg_n'] = 'Cart';
    inputMap['wt.si_p'] = 'Remove From Cart';

    deleteCompleteInputMap = {};

    postToInfinity(inputMap);
  }
};
