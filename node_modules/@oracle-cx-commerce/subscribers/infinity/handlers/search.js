/*
 ** Copyright (c) 2021 Oracle and/or its affiliates.
 */
import {getCurrentProfileId, getSearchResults} from '@oracle-cx-commerce/commerce-utils/selector';
import {postToInfinity} from '@oracle-cx-commerce/subscribers/infinity/utils';

/**
 * Search API which is triggered by handlers for
 * constructing data for sending it to Infinity
 */

let searchEventSummaryCount = 0;
export default (action, state) => {
  const {type, endpointId} = action;

  const searchResult = getSearchResults(state);

  if (
    (type === 'endpointResolved' && endpointId === 'search') ||
    (searchResult &&
      searchResult.searchEventSummary &&
      searchResult.searchEventSummary.facetFilters &&
      searchEventSummaryCount === 0)
  ) {
    const searchViewedMap = {};
    [searchViewedMap['page-uri']] = encodeURI(window.location).split('?');
    searchViewedMap['wt.dcsvid'] = getCurrentProfileId(state);
    searchViewedMap['wt.cg_n'] = 'Search';

    if (searchResult.searchEventSummary) {
      searchViewedMap['wt.oss'] = searchResult.searchEventSummary.searchTermsCanonical;
      searchViewedMap['wt.z_searchTermsRaw'] = searchResult.searchEventSummary.searchTermsRaw;
      searchViewedMap['wt.oss_r'] = searchResult.searchEventSummary.resultsSummary[0].totalMatchingRecords;
      if (searchResult.searchEventSummary.facetFilters && searchResult.searchEventSummary.facetFilters.length > 0) {
        searchEventSummaryCount = searchEventSummaryCount + 1;
        let facetName = '';
        let facetValue = '';
        for (let i = 0; i < searchResult.searchEventSummary.facetFilters.length; i++) {
          facetName = facetName.length > 0 ? facetName.concat(';') : '';
          facetName = facetName.concat(searchResult.searchEventSummary.facetFilters[i].dimensionName);

          facetValue = facetValue.length > 0 ? facetValue.concat(';') : '';
          facetValue = facetValue.concat(searchResult.searchEventSummary.facetFilters[i].spec);
        }

        searchViewedMap['wt.z_selectedSearchFacet'] = `${facetName} - ${facetValue}`;
        searchViewedMap['wt.z_ossfn'] = `${facetName}`;
        searchViewedMap['wt.z_ossfv'] = `${facetValue}`;
      }
    }
    postToInfinity(searchViewedMap);
  }
};
