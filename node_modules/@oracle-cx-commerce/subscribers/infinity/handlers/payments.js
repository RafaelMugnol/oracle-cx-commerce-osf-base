/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */
import {getOrder, getCurrentOrderId, getCurrentProfileId} from '@oracle-cx-commerce/commerce-utils/selector';
import {postToInfinity} from '@oracle-cx-commerce/subscribers/infinity/utils';

let orderId = '';

export default (action, state) => {
  const {type} = action;
  if (type === 'checkoutCart') {
    orderId = getCurrentOrderId(state);
  } else if (type === 'checkoutCartResolved') {
    const order = getOrder(state, {id: orderId});
    const isAuthorized = Object.keys(order.paymentGroups).every(
      pg => order.paymentGroups[pg].paymentState === 'AUTHORIZED'
    );
    const inputMap = {};
    [inputMap['page-uri']] = encodeURI(window.location).split('?');

    if (isAuthorized) {
      inputMap['wt.dcsvid'] = getCurrentProfileId(state);
      inputMap['wt.cg_n'] = 'Payment';
      inputMap['wt.si_p'] = 'Payment Success';
    } else {
      inputMap['wt.dcsvid'] = getCurrentProfileId(state);
      inputMap['wt.cg_n'] = 'Payment';
      inputMap['wt.si_p'] = 'Payment Fail';
    }

    postToInfinity(inputMap);
    orderId = '';
  }
};
