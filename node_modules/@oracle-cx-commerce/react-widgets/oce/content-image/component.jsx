/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */

import React, {useContext} from 'react';
import {ContainerContext, StoreContext} from '@oracle-cx-commerce/react-ui/contexts';
import {buildContentItem} from '@oracle-cx-commerce/react-widgets/oce/utils';
import {getContentItems} from '@oracle-cx-commerce/commerce-utils/selector';
import css from '@oracle-cx-commerce/react-widgets/oce/content-image/styles.css';

/**
 * Content Image widget used to display selected images from content type
 */
/* eslint-disable react/no-danger */
function ContentImage(props) {
  const store = useContext(StoreContext);
  const containerContext = useContext(ContainerContext);
  const state = store.getState();

  //retrieve the json data saved in the store
  const rawData = {...getContentItems(state, containerContext)};
  const data = Object.values(rawData.contentItems);
  const {settings = {}} = props;

  if (data) {
    let contentData = '';

    for (const [key] of Object.entries(data)) {
      const {fields: contentFields} = data[key];
      const {productField: prodField} = settings;
      //loop through the json data and check if the key matches the
      // entry set in admin
      // eslint-disable-next-line no-loop-func
      Object.entries(contentFields).forEach(function ([key, value]) {
        if (key === prodField) {
          if (Array.isArray(value)) {
            for (const val of value) {
              contentData += buildContentItem(val);
            }
          } else if (typeof value == 'object' && typeof value.fields !== 'undefined') {
            // this is a json object so needs built
            contentData += buildContentItem(value);
            // eslint-disable-next-line no-prototype-builtins
          } else if (value.hasOwnProperty('productAwareImage')) {
            //this is a product aware image which needs to be built
            contentData += buildContentItem(value.productAwareImage);
          }
        }
      });
    }

    return <div className="ContentImage" css={css} dangerouslySetInnerHTML={{__html: contentData}}></div>;
  }

  return <div className="ContentImage"></div>;
}

export default ContentImage;
