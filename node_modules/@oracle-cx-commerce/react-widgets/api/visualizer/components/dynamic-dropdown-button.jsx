/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */

import React, {useState, useEffect} from 'react';
import {t} from '@oracle-cx-commerce/utils/generic';

const DynamicDropdownButton = props => {
  const {state} = props;

  return (
    <>
      {Object.keys(state).map(function (rootDropdownCategory) {
        return <RootDropdownButton key={rootDropdownCategory} category={rootDropdownCategory} {...props} />;
      })}
    </>
  );
};

const RootDropdownButton = props => {
  const {state = {}, category, currentURL, basePageURL, allExpanded} = props;
  const [expanded, setExpanded] = useState(false);

  useEffect(() => {
    const splitUrl = currentURL.substring(1).split('/');

    if (splitUrl.length > 1) {
      const [currentPageCategory, , currentPageItemName] = splitUrl;
      setExpanded(currentPageCategory === category && currentPageItemName);
    } else {
      setExpanded(false);
    }
  }, [category, currentURL]);

  useEffect(() => {
    setExpanded(allExpanded);
  }, [allExpanded]);

  if (typeof state[category] === 'undefined') return null;

  return (
    <ul className="dropdown-content level-0">
      <button
        type="button"
        onClick={() => {
          setExpanded(!expanded);
        }}
      >
        {t(category)}
        <i className={`fa fa-caret-${expanded ? 'down' : 'right'}`}></i>
      </button>

      {expanded &&
        Object.keys(state[category]).map(function (subCat) {
          return (
            <DropdownMenuItemList
              key={subCat}
              currentURL={currentURL}
              state={state}
              category={category}
              subCategory={subCat}
              basePageURL={basePageURL}
            />
          );
        })}
    </ul>
  );
};

const DropdownMenuItemList = props => {
  const {state = {}, category, subCategory, currentURL, basePageURL} = props;
  const categoryList = state[category][subCategory];
  const hrefPath = `${basePageURL}#${category}/${subCategory}/`;

  const splitUrl = currentURL.substring(1).split('/');

  let currentPageCategory = '',
    currentPageSubCategory = '',
    currentPageItemName = '';

  if (splitUrl.length > 1) {
    [currentPageCategory, currentPageSubCategory, currentPageItemName] = splitUrl;
  }

  const getClassName = item => {
    let className = 'dropdown-content level-2';

    className +=
      currentPageCategory === category && currentPageSubCategory === subCategory && item.name === currentPageItemName
        ? ' selected_dropdown-content'
        : '';

    return className;
  };

  return (
    <>
      {categoryList.map(item => (
        <li key={item.name} className={getClassName(item)}>
          <a href={`${hrefPath}${item.name}`}>{item.name}</a>
        </li>
      ))}
    </>
  );
};

export default DynamicDropdownButton;
