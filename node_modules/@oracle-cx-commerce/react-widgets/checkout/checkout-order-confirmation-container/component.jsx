/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */

import {StoreContext, ContainerContext} from '@oracle-cx-commerce/react-ui/contexts';
import React, {useContext, useEffect, useState} from 'react';
import Region from '@oracle-cx-commerce/react-components/region';
import Styled from '@oracle-cx-commerce/react-components/styled';
import {connect} from '@oracle-cx-commerce/react-components/provider';
import css from '@oracle-cx-commerce/react-widgets/checkout/checkout-order-confirmation-container/styles.css';
import OrderConfirmationPlaceholder from '@oracle-cx-commerce/react-widgets/checkout/checkout-order-confirmation-container/components/order-confirmation-placeholder';
import PageLoader from '@oracle-cx-commerce/react-components/page-loader';
import {getComponentData} from '@oracle-cx-commerce/react-widgets/checkout/checkout-order-confirmation-container/selectors';

/**
 * Container that holds all the widget of the confirmation page
 */
const CheckoutOrderConfirmationContainer = props => {
  const {regions = [], uuid = '', orderId = '', ...order} = props;
  const [showPageLoader, setShowPageLoader] = useState(true);

  //context
  const {action} = useContext(StoreContext);

  /**
   * Invokes get order confirmation details action to get the details of placed order
   */
  useEffect(() => {
    if (uuid) {
      const payload = {uuid};
      action('getOrderConfirmation', payload).then(response => {
        setShowPageLoader(false);
        if (response.ok === false) {
          action('notify', {level: 'error', message: response.error.message});
        }
      });
    }
  }, [action, uuid]);

  return (
    <Styled id="CheckoutOrderConfirmationContainer" css={css}>
      <div className="CheckoutOrderConfirmationContainer">
        <PageLoader show={showPageLoader}>
          <OrderConfirmationPlaceholder />
        </PageLoader>
        {orderId && (
          <React.Fragment>
            <ContainerContext.Provider value={{orderId, ...order}}>
              <section className="CheckoutOrderConfirmationContainer__Section">
                {regions.map((regionId, index) => (
                  /*
                    Using region ids as keys causes unnecessary DOM reconciliation.
 
                    https://reactjs.org/docs/reconciliation.html#keys
                  */
                  // eslint-disable-next-line react/no-array-index-key
                  <Region key={index} regionId={regionId} />
                ))}
              </section>
            </ContainerContext.Provider>
          </React.Fragment>
        )}
      </div>
    </Styled>
  );
};

export default connect(getComponentData)(CheckoutOrderConfirmationContainer);
