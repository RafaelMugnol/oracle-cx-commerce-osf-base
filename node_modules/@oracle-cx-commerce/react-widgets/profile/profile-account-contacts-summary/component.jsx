/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */
import React, {Suspense, useContext, useEffect, useMemo, useRef, useState} from 'react';

import PropTypes from 'prop-types';
import {StoreContext} from '@oracle-cx-commerce/react-ui/contexts';
import Styled from '@oracle-cx-commerce/react-components/styled';
import {connect} from '@oracle-cx-commerce/react-components/provider';
import css from '@oracle-cx-commerce/react-widgets/profile/profile-account-contacts-summary/styles.css';
import {getAddressManagerRoles} from '@oracle-cx-commerce/react-components/utils/address';
import {getComponentData} from '@oracle-cx-commerce/react-widgets/profile/profile-account-contacts-summary/selectors';

const AccountContactsDetails = React.lazy(() =>
  import(
    '@oracle-cx-commerce/react-widgets/profile/profile-account-contacts-summary/components/account-contacts-details'
  )
);

/**
 * Widget to display the profile account contacts summary at profile page.
 * @param {Object} props the properties object
 */
const ProfileAccountContactsSummary = props => {
  const {action} = useContext(StoreContext);
  const {headingAccountContacts} = props;
  const {roles} = props;
  const [activeContacts, setActiveContacts] = useState();
  const [inActiveContacts, setInActiveContacts] = useState();
  const actionInvokeRef = useRef(true);
  const profileRoles = useMemo(() => getAddressManagerRoles(roles), [roles]);

  /* Pulls list of active and inactive organization member */
  useEffect(() => {
    if (profileRoles && profileRoles.isAdmin && actionInvokeRef.current) {
      actionInvokeRef.current = false;
      action('listOrganizationMembers', {
        q: `active eq true`
      }).then(response => {
        if (response.ok && response.json && response.json.items) {
          setActiveContacts(response.json.totalResults);
        }
      });
      action('listOrganizationMembers', {
        q: `active eq false`
      }).then(response => {
        if (response.ok && response.json && response.json.items) {
          setInActiveContacts(response.json.totalResults);
        }
      });
    }
  }, [action, setActiveContacts, setInActiveContacts, profileRoles]);

  return (
    profileRoles &&
    profileRoles.isAdmin && (
      <Styled id="ProfileAccountContactsSummary" css={css}>
        <div className="ProfileAccountContactsSummary">
          <h2>{headingAccountContacts}</h2>
          <Suspense fallback={null}>
            <AccountContactsDetails inActiveContacts={inActiveContacts} activeContacts={activeContacts} {...props} />
          </Suspense>
        </div>
      </Styled>
    )
  );
};

ProfileAccountContactsSummary.propTypes = {
  /**
   * The roles (user roles) object from redux state(ProfileRepository->roles)
   */
  roles: PropTypes.objectOf(
    PropTypes.shape({
      repositoryId: PropTypes.string.isRequired,
      function: PropTypes.string.isRequired
    })
  ).isRequired
};

export default connect(getComponentData)(ProfileAccountContactsSummary);
