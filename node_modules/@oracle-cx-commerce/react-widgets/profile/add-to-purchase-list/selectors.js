/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */

import {useContext, useEffect} from 'react';
import {StoreContext, ProductSelectionContext} from '@oracle-cx-commerce/react-ui/contexts';
import {getComponentData, getCurrentPageId} from '@oracle-cx-commerce/commerce-utils/selector';
import {getProductDetails} from '@oracle-cx-commerce/react-widgets/profile/add-to-purchase-list/utils';

/**
 * Custom React hook to compute product details from the information provided through `ProductSelectionContext`
 */
export const useComponentData = () => {
  const {getState} = useContext(StoreContext);
  const {productSelection} = useContext(ProductSelectionContext);

  if (Array.isArray(productSelection)) {
    // multiple products selected
    return productSelection.map(item => getProductDetails(getState(), item));
  }

  if (typeof productSelection === 'object') {
    // single product selected
    return getProductDetails(getState(), productSelection);
  }

  return {};
};

/**
 * Custom React hook to automatically open AddToPurchaseList modal after login
 */
export const useAutoOpen = handler => {
  let autoOpen = false;
  const {action, getState} = useContext(StoreContext);

  const componentData = getComponentData(getState());
  const currentPageId = getCurrentPageId(getState());

  if (
    componentData['pages'] &&
    componentData['pages'][currentPageId] &&
    componentData['pages'][currentPageId]['showAddToPurchaseList']
  ) {
    autoOpen = true;
  }

  useEffect(() => {
    if (autoOpen) {
      handler();

      action('saveComponentData', {
        pages: {
          [getCurrentPageId(getState())]: {
            showAddToPurchaseList: false
          }
        }
      });
    }
  }, [action, autoOpen, getState, handler]);
};
