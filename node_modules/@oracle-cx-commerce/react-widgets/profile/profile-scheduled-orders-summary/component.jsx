/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */
import React, {useContext, useEffect, useState} from 'react';
import Styled from '@oracle-cx-commerce/react-components/styled';
import {getComponentData} from '@oracle-cx-commerce/react-widgets/profile/profile-scheduled-orders-summary/selectors';
import ScheduledOrdersDetails from '@oracle-cx-commerce/react-widgets/profile/profile-scheduled-orders-summary/components/scheduled-orders-details';
import {StoreContext} from '@oracle-cx-commerce/react-ui/contexts';
import {connect} from '@oracle-cx-commerce/react-components/provider';
import css from '@oracle-cx-commerce/react-widgets/profile/profile-scheduled-orders-summary/styles.css';
import PropTypes from 'prop-types';

/**
 * Widget to display the scheduled orders summary at profile page.
 * @param {Object} props the properties object
 */
const ProfileScheduledOrdersSummary = props => {
  const {headingScheduledOrders} = props;
  const {numberOfUpcomingOrdersToDisplay} = props;
  const {action} = useContext(StoreContext);
  const [scheduledOrders, setScheduledOrders] = useState();
  const [totalScheduledOrders, setTotalScheduledOrders] = useState();

  /* Pulls the list of upcoming scheduled orders */
  useEffect(() => {
    action('listScheduledOrders', {
      sort: 'nextScheduledRun:asc',
      offset: 0,
      limit: numberOfUpcomingOrdersToDisplay
    }).then(response => {
      if (response.ok && response.json && response.json.items) {
        setScheduledOrders(response.json.items);
        setTotalScheduledOrders(response.json.totalResults);
      }
    });
  }, [action, numberOfUpcomingOrdersToDisplay, setScheduledOrders]);

  return (
    <Styled id="ProfileScheduledOrdersSummary" css={css}>
      <div className="ProfileScheduledOrdersSummary">
        <h2>{headingScheduledOrders}</h2>
        <ScheduledOrdersDetails
          scheduledOrders={scheduledOrders}
          totalScheduledOrders={totalScheduledOrders}
          {...props}
        />
      </div>
    </Styled>
  );
};

ProfileScheduledOrdersSummary.propTypes = {
  /** Number of upcoming scheduled orders */
  numberOfUpcomingOrdersToDisplay: PropTypes.number
};

ProfileScheduledOrdersSummary.defaultProps = {
  numberOfUpcomingOrdersToDisplay: 5
};

export default connect(getComponentData)(ProfileScheduledOrdersSummary);
