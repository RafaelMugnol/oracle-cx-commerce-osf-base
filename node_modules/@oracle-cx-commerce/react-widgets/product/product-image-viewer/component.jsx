/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */

import React, {useCallback, useEffect, useState, useContext} from 'react';
import {StoreContext} from '@oracle-cx-commerce/react-ui/contexts';
import Modal from '@oracle-cx-commerce/react-components/modal';
import ProductImagePanel from '@oracle-cx-commerce/react-widgets/product/product-image-viewer/components/product-image-panel';
import {isMobile} from '@oracle-cx-commerce/commerce-utils/selector';
import Styled from '@oracle-cx-commerce/react-components/styled';
import css from '@oracle-cx-commerce/react-widgets/product/product-image-viewer/styles.css';
import {useComponentData} from '@oracle-cx-commerce/react-widgets/product/product-image-viewer/selectors';
import {noop} from '@oracle-cx-commerce/utils/generic';

/**
 * Product Image component. Gathers image data and renders a ProductImageSlider component.
 */
const ProductImageViewer = props => {
  // selector
  const {primaryImageTitle, activeImages, thumbImages} = useComponentData();
  const mobile = isMobile(useContext(StoreContext).getState());

  // state
  const [portalRendered, setPortalRendered] = useState(false);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [portalOpenedOnce, setPortalOpenedOnce] = useState(false);

  const {closeLinkAltText, cssOverride} = props;
  portalRendered && !portalOpenedOnce && setPortalOpenedOnce(true);

  /**
   * Handler for clicking close
   */
  const closePortal = useCallback(() => {
    setPortalRendered(false);
  }, []);

  /**
   * When a different Sku is selected, reset the slider Images index to zero
   */
  useEffect(() => {
    setCurrentIndex(0);
  }, [activeImages]);

  return (
    <Styled id="ProductImageViewer" css={css}>
      <div className="ProductImageViewer">
        <ProductImagePanel
          primaryImageTitle={primaryImageTitle}
          images={activeImages}
          thumbs={thumbImages}
          portalRendered={portalRendered}
          setPortalRenderedCallback={setPortalRendered}
          showExpand={true}
          currentIndex={currentIndex}
          setCurrentIndex={setCurrentIndex}
          mobile={mobile}
          {...props}
        />

        <Modal
          cssOverride={cssOverride}
          className="ProductImageViewer__Modal"
          show={portalRendered}
          onClose={closePortal}
          closeIconTitle={closeLinkAltText}
          closeArialLabel={closeLinkAltText}
        >
          {portalOpenedOnce && (
            <ProductImagePanel
              primaryImageTitle={primaryImageTitle}
              images={activeImages}
              thumbs={thumbImages}
              portalRendered={portalRendered}
              setPortalRenderedCallback={noop}
              showExpand={false}
              currentIndex={currentIndex}
              setCurrentIndex={setCurrentIndex}
              mobile={mobile}
              {...props}
            />
          )}
        </Modal>
      </div>
    </Styled>
  );
};

export default ProductImageViewer;
