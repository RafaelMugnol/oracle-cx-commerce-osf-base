/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */

import {CartItemContext, ProductSelectionContext} from '@oracle-cx-commerce/react-ui/contexts';
import {
  CartItemPromotion,
  CartItemQuantityDisplayAndUpdate,
  CartItemRemoveLink,
  CartItemStockStatus,
  CartItemSurcharge,
  CartItemUpdateError,
  CartItemSiteInformation
} from '@oracle-cx-commerce/react-widgets/cart/cart-item-details/components/cart-line-item-components';
import {
  CommerceItemFreeGiftIconMessage,
  CommerceItemImage,
  CommerceItemName,
  CommerceItemPrice,
  CommerceItemQty,
  CommerceItemTotalPrice,
  CommerceItemVariants
} from '@oracle-cx-commerce/react-widgets/cart/cart-item-details/components/commerce-item-components';
import React, {useMemo, useState} from 'react';

import AddToPurchaseList from '@oracle-cx-commerce/react-widgets/profile/add-to-purchase-list/component';
import GWPItemChangeLink from '@oracle-cx-commerce/react-widgets/cart/cart-item-details/components/gwp-item-change-link';
import MoveProductToWishList from '@oracle-cx-commerce/react-widgets/cart/cart-item-details/components/move-product-to-wishlist';
import Styled from '@oracle-cx-commerce/react-components/styled';
import css from '@oracle-cx-commerce/react-widgets/cart/cart-item-details/components/cart-item-row/styles.css';
import {useCartItemState} from '@oracle-cx-commerce/react-components/utils/cart/hooks';
import {ORDER_STATE_QUOTED} from '@oracle-cx-commerce/commerce-utils/constants';
import CartAddOnItems from '@oracle-cx-commerce/react-widgets/cart/cart-item-details/components/cart-add-on-items';

/**
 * It display each cart item in shopping cart based on the current viewport.
 *
 * @param {*} props
 */
const CartItemRow = props => {
  const {
    shippingGroupCommerceItem = {},
    commerceItem = {},
    shippingGroupId,
    showItemPrice,
    currentOrder: {shippingGroups, state},
    setInvalidItems,
    setInvalidItemsOnQuantityChange,
    messageInsufficientStock,
    messageInsufficientStockAtStore,
    pdpUrlNotRequired,
    messagePartialPreOrder,
    messagePartialBackOrder,
    messageItemNoLongerAvailable,
    showAddOnItems = true
  } = props;
  const [triggerRemoveItem, setTriggerRemoveItem] = useState(false);

  /**
   * Filtering add-on items from child items using "addOnItem" flag
   */
   const addOnItems = useMemo(() => {
    if (showAddOnItems && shippingGroupCommerceItem.childItems && shippingGroupCommerceItem.childItems.length > 0) {
      return shippingGroupCommerceItem.childItems.filter(item => item.addOnItem === true);
    } else {
      return [];
    }
  }, [shippingGroupCommerceItem, showAddOnItems]);

  /**
   * Cart Item status from the custom hook - useCartItemState
   */
  const {cartItemDetails, isItemInValid} = useCartItemState({
    commerceItem,
    shippingGroupCommerceItem,
    shippingGroups,
    shippingGroupId,
    showItemPrice,
    pdpUrlNotRequired,
    setInvalidItems,
    setInvalidItemsOnQuantityChange,
    messageInsufficientStock,
    triggerRemoveItem,
    messageInsufficientStockAtStore
  });

  // Product selection context data
  const productSelection = {
    commerceItem,
    shippingGroups,
    shippingGroupId,
    setTriggerRemoveItem
  };

  return (
    <Styled id="CartItemRow" css={css}>
      <CartItemContext.Provider value={cartItemDetails}>
        <ProductSelectionContext.Provider value={{productSelection}}>
          <div className={`CartItemRow ${isItemInValid || state === ORDER_STATE_QUOTED ? 'CartItem__Disable' : ''}`}>
            <div>
              <div className="CartItemDetails__ItemDetails">
                <CommerceItemImage />
                <div className="CartItemDetails__ItemBasicDetails">
                  <CommerceItemName />
                  <CommerceItemVariants />
                  <div className="CartItemDetails__MobileVisible">
                    {props.showItemPrice && <CommerceItemPrice messageAtTheRate={props.messageAtTheRate} />}
                  </div>
                  {commerceItem.giftWithPurchaseCommerceItemMarkers &&
                    commerceItem.giftWithPurchaseCommerceItemMarkers.length > 0 && <GWPItemChangeLink {...props} />}
                  <CartItemStockStatus {...props} />
                  <CartItemPromotion />
                  <CommerceItemFreeGiftIconMessage textFreeGift={props.textFreeGift} />
                  <CartItemSurcharge shippingSurchargeText={props.shippingSurchargeText} />
                  {props.displayCartItemSiteInfo && <CartItemSiteInformation textSiteIcon={props.textSiteIcon} />}
                </div>
                <div className="CartItemDetails__DesktopVisible">
                  <CommerceItemPrice messageAtTheRate={props.messageAtTheRate} />
                </div>
                <div className="CartItemDetails__QuantityTotalContainer">
                  <div className="CartItemDetails__Quantity">
                    {commerceItem.giftWithPurchaseCommerceItemMarkers &&
                    commerceItem.giftWithPurchaseCommerceItemMarkers.length > 0 ? (
                      <CommerceItemQty />
                    ) : (
                      <CartItemQuantityDisplayAndUpdate {...props} />
                    )}
                  </div>
                  <div className="CartItemDetails__Total">
                    <CommerceItemTotalPrice textFree={props.textFree} />
                  </div>
                </div>
              </div>
              <CartItemUpdateError
                invalidItemsOnQuantityChange={props.invalidItemsOnQuantityChange}
                currentOrder={props.currentOrder}
                messageInsufficientStock={messageInsufficientStock}
                messageInsufficientStockAtStore={messageInsufficientStockAtStore}
                messagePartialPreOrder={messagePartialPreOrder}
                messagePartialBackOrder={messagePartialBackOrder}
                messageItemNoLongerAvailable={messageItemNoLongerAvailable}
              />
              {addOnItems.length > 0 && (
                <CartAddOnItems {...props} addOnItems={addOnItems} isEditable={true} isChildItem={false}></CartAddOnItems>
              )}
              <div className="CartItemDetails__BOPIS"></div>
              <div className="CartItemDetails__ActionLinks">
                <div className="CartItemDetails__ActionLinksLeftCol">
                  {props.showAddToPurchaseList && <AddToPurchaseList {...props} />}
                  {props.showMoveToWishList && <MoveProductToWishList {...props} />}
                </div>
                {state !== ORDER_STATE_QUOTED && <CartItemRemoveLink {...props} />}
              </div>
            </div>
          </div>
        </ProductSelectionContext.Provider>
      </CartItemContext.Provider>
    </Styled>
  );
};

export default React.memo(CartItemRow);
