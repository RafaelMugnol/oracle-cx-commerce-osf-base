/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */

const {Request} = require('node-fetch');

const createOccRestRequest =
  (req, res) =>
  (url, additionalOptions = {}) => {
    const headers = {
      Accept: 'application/json',
      'Content-Type': 'application/json',
      'X-CCProfileType': 'storefrontUI',
      'X-CC-MeteringMode': 'CC-NonMetered'
    };

    const setHeader = name => {
      const value = res.locals[name] || req.get(name);

      if (value) {
        headers[name] = value;
      }
    };

    setHeader('Accept-Language');
    setHeader('Authorization');
    setHeader('Cookie');
    setHeader('User-Agent');
    setHeader('X-CC-Frontend-Forwarded-Url');
    setHeader('X-CCAsset-Language');
    setHeader('X-CCOrganization');
    setHeader('X-CCPriceListGroup');
    setHeader('X-CCSite');
    setHeader('X-CCVisitId');
    setHeader('X-CCVisitorId');
    setHeader('X-CCInitvisitID');
    setHeader('X-ThousandEyes-Agent');
    setHeader('X-CC-Client');
    setHeader('X-CCFirstSessionRequest');
    setHeader('CLIENT_IP');
    setHeader('Host');
    setHeader('Forwarded');
    setHeader('X-Forwarded-For');
    setHeader('X-Forwarded-Host');
    setHeader('X-Forwarded-Proto');
    setHeader('WL-Proxy-SSL');

    const options = {
      credentials: 'include',
      ...additionalOptions,
      headers: {
        ...headers,
        ...additionalOptions.headers
      }
    };

    return new Request(url, options);
  };

module.exports = {
  createOccRestRequest
};
