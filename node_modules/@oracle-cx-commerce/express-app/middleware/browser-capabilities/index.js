/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */

const capabilities = require('./inhouse-browser-capabilities');

const isMobile = userAgent => {
  return userAgent.toLowerCase().includes('mobi');
};

const setBrowserCapabilities = (req, res) => {
  const userAgent = req.get('User-Agent') || '';

  // Initialize browser capabilities from user agent
  const browserCapabilities = capabilities.browserCapabilities(userAgent);

  // Initialize the `[is]mobile` capability--as it's not provided as standard
  if (isMobile(userAgent)) {
    browserCapabilities.add('mobile');
  }

  res.locals.browserCapabilities = browserCapabilities;
};

/*
  Compute the set of browser capabilities based on the 'User-Agent' header of the current request. Make the set of capabilities available to subsequent middleware via `res.locals.browserCapabilities`.
 */
module.exports = () => {
  return {
    browserCapabilities(req, res, next) {
      // Make browserCapabilities available to the middleware chain
      setBrowserCapabilities(req, res);

      next();
    }
  };
};
