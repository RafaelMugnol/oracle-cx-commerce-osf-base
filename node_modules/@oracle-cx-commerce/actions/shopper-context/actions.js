/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */

/* eslint-env browser */

import {endpointSaga, takeLeading} from '@oracle-cx-commerce/store/utils';
import {select} from 'redux-saga/effects';
import {getGlobalContext, getSessionContext} from '@oracle-cx-commerce/commerce-utils/selector';

const setCookie = state => {
  const {priceListGroup} = getGlobalContext(state);
  const {OCStateData} = getSessionContext(state);

  if (OCStateData) {
    document.cookie = `OCStateData=${OCStateData};SameSite=Strict;path=/`;
    document.cookie = `storePriceListGroupId=${priceListGroup};SameSite=Strict;path=/`;
  }
};

function* shopperContextSaga(action) {
  const response = yield endpointSaga(action);

  if (response.ok === true) {
    const state = yield select();
    setCookie(state);
  }

  return response;
}

export default {
  *saga() {
    yield takeLeading('setShopperContext', shopperContextSaga);
  }
};
