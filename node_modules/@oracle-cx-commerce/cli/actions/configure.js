/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */

const logger = require('@oracle-cx-commerce/logger/cli');
const {loadWorkspaceConfig, createWorkspaceConfig, cliHelperMethods} = require('@oracle-cx-commerce/cli-shared');
const {___} = require('@oracle-cx-commerce/tools-i18n').i18n({directory: require('path').join(__dirname, './locales')});

function displayCurrentConfiguration() {
  const config = loadWorkspaceConfig();
  const str = JSON.stringify(config, null, 2); // spacing level = 2
  logger.info(`${str}`);
  if (!cliHelperMethods.validateConfiguration(config)) {
    console.error(
      ___`The combined configuration file has an invalid configuration. Use yarn configure to set a new value. Also check for environment variable configuration overrides for the reported values.`
    );
  }
}
/*
 *  This command will create/update .occ/config.js with configuration
 */
module.exports = options => {
  // Already ran 'getProgramConfiguration' before method call in cli.js
  const allopts = options;

  if (allopts._occSelectedOptions.length === 0 || allopts.list) {
    displayCurrentConfiguration();

    return;
  }

  createWorkspaceConfig(process.cwd(), allopts);

  logger.info(___`This is the final, combined workspace configuration:`);
  // display the config after the update
  displayCurrentConfiguration();
};
