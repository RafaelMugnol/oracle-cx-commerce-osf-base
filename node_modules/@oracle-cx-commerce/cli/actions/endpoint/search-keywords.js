/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */

const logger = require('@oracle-cx-commerce/logger/cli');
const path = require('path');
const fs = require('fs');
const {___} = require('@oracle-cx-commerce/tools-i18n').i18n({directory: path.join(__dirname, './locales')});
const {getRequestHandler} = require('./request-handler');

/**
 * CLI action function that uploads the search keyword list.
 *
 * @param {String} appName The name of the application (unused)
 * @param {String} options.appServerAdmin The URL of the server
 * @param {String} options.appKey A string to perform authentication on the server
 */
const uploadCustomTypeaheadKeywords = async (appName, options) => {
  try {
    const inputFile = `${options.appDir}/config/search/data/keywords.js`;
    const keywords = path.resolve(inputFile);
    if (!fs.existsSync(keywords)) {
      throw new Error(___`Could not find keywords file '${keywords}'`);
    }
    const url = options.appServerAdmin;
    const requestHandler = await getRequestHandler(url, options.appKey);
    logger.info(___`Uploading search keyword list '${keywords}' to admin server '${url}'`);
    await requestHandler({
      method: 'post',
      path: '/gsdata/v1/cloud/data/keywords',
      content: keywords
    });
    logger.info(___`Finished upload.`);
    logger.info(___`Remember to initiate the catalog indexing.`);
  } catch (e) {
    logger.error(___`Unable to upload keywords`);
    throw e;
  }
};

module.exports = {
  uploadCustomTypeaheadKeywords
};
