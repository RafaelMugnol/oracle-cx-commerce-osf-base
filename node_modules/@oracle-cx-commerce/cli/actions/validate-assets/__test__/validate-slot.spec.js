/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */
const path = require('path');
const fs = require('fs');

const {validateAssets} = require('@oracle-cx-commerce/cli/actions/validate-assets/index');

const coreCommerceReferenceStoreOptions = {
  appName: 'core-commerce-reference-store',
  userName: 'dev',
  name: 'exampleAssetValidation',
  appDir: path.resolve(
    path.relative('.', __dirname),
    'validation-examples',
    'slot-examples',
    'core-commerce-reference-store'
  )
};

const pathToSampleAppJson = path.resolve(path.relative('.', __dirname), 'validation-examples', 'sample-app.json');
const mockAppJson = JSON.parse(fs.readFileSync(pathToSampleAppJson, 'utf-8')).components;

jest.mock('@oracle-cx-commerce/cli/actions/validate-assets/asset-validation-utils.js', () => {
  const original = jest.requireActual('@oracle-cx-commerce/cli/actions/validate-assets/asset-validation-utils.js');

  return {
    ...original,
    isAppJsonPresent: jest.fn(() => true),
    getAppJsonComponents: jest.fn(() => mockAppJson)
  };
});

describe('validate-assets:all  -  all the tests that will invoke validate-assets with different options', () => {
  beforeAll(async () => {});
  afterAll(async () => {});

  test('validate-assets:validate-slot-class-exists - check that slot class is present', () => {
    const newPath = path.resolve(path.relative('.', __dirname), '..', 'slot.js');
    expect(fs.existsSync(newPath)).toBeTruthy();
  });

  test('validate-assets:all-cases-pass-validation - check that all cases pass validation', async () => {
    const options = {
      ...coreCommerceReferenceStoreOptions,
      appDir: path.resolve(
        path.relative('.', __dirname),
        'validation-examples',
        'slot-examples',
        'core-commerce-reference-store'
      )
    };
    await expect(validateAssets(options.appName, options)).resolves.not.toThrow();
  });

  test('validate-assets:check-required-properties-does-not-exists - check proper messages shows up when required properties does not exists', async () => {
    const options = {
      ...coreCommerceReferenceStoreOptions,
      appDir: path.resolve(
        path.relative('.', __dirname),
        'validation-examples',
        'slot-examples',
        'required-properties-not-exist',
        'core-commerce-reference-store'
      )
    };
    await expect(validateAssets(options.appName, options)).rejects.toThrow(
      `Asset validation failed, found 3 issue(s). Please see issue(s) listed above.`
    );
  });
  test('validate-assets:check-properties-with-invalid-values - check proper messages shows up when properties contain invalid values', async () => {
    const options = {
      ...coreCommerceReferenceStoreOptions,
      appDir: path.resolve(
        path.relative('.', __dirname),
        'validation-examples',
        'slot-examples',
        'invalid-values',
        'core-commerce-reference-store'
      )
    };
    await expect(validateAssets(options.appName, options)).rejects.toThrow(
      `Asset validation failed, found 10 issue(s). Please see issue(s) listed above.`
    );
  });
  test('validate-assets:cross-validations - check proper messages shows up when doing cross validation for slots', async () => {
    const options = {
      ...coreCommerceReferenceStoreOptions,
      appDir: path.resolve(
        path.relative('.', __dirname),
        'validation-examples',
        'slot-examples',
        'cross-validation',
        'core-commerce-reference-store'
      )
    };
    await expect(validateAssets(options.appName, options)).rejects.toThrow(
      `Asset validation failed, found 1 issue(s). Please see issue(s) listed above.`
    );
  });
});
