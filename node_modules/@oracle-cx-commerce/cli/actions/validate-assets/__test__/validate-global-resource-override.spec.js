/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */
const path = require('path');
const fs = require('fs');

const {validateAssets} = require('@oracle-cx-commerce/cli/actions/validate-assets/index');

const coreCommerceReferenceStoreOptions = {
  appName: 'core-commerce-reference-store',
  userName: 'dev',
  name: 'exampleAssetValidation',
  appDir: path.resolve(
    path.relative('.', __dirname),
    'validation-examples',
    'global-resource-override-examples',
    'core-commerce-reference-store'
  )
};

const pathToSampleAppJson = path.resolve(path.relative('.', __dirname), 'validation-examples', 'sample-app.json');
const mockAppJson = JSON.parse(fs.readFileSync(pathToSampleAppJson, 'utf-8')).components;

jest.mock('@oracle-cx-commerce/cli/actions/validate-assets/asset-validation-utils.js', () => {
  const original = jest.requireActual('@oracle-cx-commerce/cli/actions/validate-assets/asset-validation-utils.js');

  return {
    ...original,
    isAppJsonPresent: jest.fn(() => true),
    getAppJsonComponents: jest.fn(() => mockAppJson)
  };
});

describe('validate-assets:all - all the tests that will invoke validate-assets with different options', () => {
  beforeEach(async () => {});
  afterEach(async () => {});

  test('validate-assets:validate-global-resource-override-class-exists - check that global resource override class is present', () => {
    const newPath = path.resolve(path.relative('.', __dirname), '..', 'global-resource-override.js');
    expect(fs.existsSync(newPath)).toBeTruthy();
  });

  test('validate-assets:all-cases-pass-validation - check that all cases pass validation', async () => {
    const options = {
      ...coreCommerceReferenceStoreOptions,
      appDir: path.resolve(
        path.relative('.', __dirname),
        'validation-examples',
        'global-resource-override-examples',
        'core-commerce-reference-store'
      )
    };
    await expect(validateAssets(options.appName, options)).resolves.not.toThrow();
  });

  test('validate-assets:check-name-value-pairs-exceed-500-characters - check proper messages shows up when name value pairs exceed 500 characters', async () => {
    const options = {
      ...coreCommerceReferenceStoreOptions,
      appDir: path.resolve(
        path.relative('.', __dirname),
        'validation-examples',
        'global-resource-override-examples',
        'exceed-500-characters',
        'core-commerce-reference-store'
      )
    };
    await expect(validateAssets(options.appName, options)).rejects.toThrow(
      `Asset validation failed, found 1 issue(s). Please see issue(s) listed above.`
    );
  });
});
