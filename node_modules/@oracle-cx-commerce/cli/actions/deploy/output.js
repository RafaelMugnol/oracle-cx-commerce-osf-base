/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */

const path = require('path');
const createTemplate = require('../create-app-zip');
const {createAppJson} = require('../bundle');

// Just generate the output files for the deployment.
module.exports = async (appName, options) => {
  createAppJson(appName, options);

  options.dest = options.dest || path.join(options.appDir, '.occ', 'deployments');
  options.zipConfigPath = options.zipConfigPath || './../config/deploy.json';

  return createTemplate(appName, options, (archive, externalPkgs) => {
    // In the deploy case, include the deployment.json metadata file
    const deployJson = {
      appDir: options.appDir,
      tags: options.tag,
      appName,
      externalPkgs
    };
    if (options.localDevAppName !== undefined && typeof options.localDevAppName === 'string') {
      deployJson.isLocalDevApp = true;
      //leaving the following line here for now so the new version of the cli will still work
      //properly with old version of occ that rely on this value to bypass deployment
      //to the controllers
      //It can be removed once we are comfortable all customers are beyond the
      //version with this change.
      deployJson.clusterId = 'NO_CLUSTER_DEPLOY';
    }
    archive.append(JSON.stringify(deployJson), {name: 'deployment.json'});
  });
};
