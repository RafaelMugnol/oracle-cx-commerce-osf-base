/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */

const {Client} = require('@oracle-cx-commerce/tools-util/rest-client');
const {deleteApplication} = require('@oracle-cx-commerce/tools-util/endpoints');
const logger = require('@oracle-cx-commerce/logger/cli');
const {___} = require('@oracle-cx-commerce/tools-i18n').i18n({directory: require('path').join(__dirname, './locales')});
const {doPublish} = require('./publish');

const deleteApp = async (appName, options) => {
  const restClient = new Client(options.appServerAdmin, options.appKey);

  logger.info(___`Connecting to ${options.appServerAdmin}`);

  await restClient.login();
  logger.info(___`Deleting application ${appName} from ${options.appServerAdmin}`);

  try {
    await deleteApplication({restClient, appName});
    logger.info(___`Successfully deleted application ${appName} from ${options.appServerAdmin}`);
    if (options.publish || options.publishAll) {
      logger.info(___`Publish initiated.`);
      await doPublish(options);
    }
  } catch (error) {
    if (error.response && error.response.status === 404) {
      logger.info(___`Application ${appName} not found on ${options.appServerAdmin}`);
    } else {
      throw error;
    }
  }
};

module.exports = {
  deleteApp
};
