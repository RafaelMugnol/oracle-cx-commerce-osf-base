/*
 ** Copyright (c) 2021 Oracle and/or its affiliates.
 */
const path = require('path');
const createTempDir = require('tmp-promise').dir;
const fse = require('fs-extra');
const {discoverTemplateFiles} = require('@oracle-cx-commerce/cli/templates/utils');

function validateOutputFiles(expectedOutput, generatedOutput) {
  console.log(`comparing: ${expectedOutput} to ${generatedOutput}`);
  const expectedFileList = discoverTemplateFiles(expectedOutput);
  expectedFileList.forEach(expectedFile => {
    const expectedContent = fse.readFileSync(path.resolve(expectedOutput, expectedFile), 'utf-8');
    const generatedContent = fse.readFileSync(path.resolve(generatedOutput, expectedFile), 'utf-8');
    if (path.parse(expectedFile).ext === '.json') {
      const expectedContentJsonData = JSON.parse(expectedContent);
      const generatedContentJsonData = JSON.parse(generatedContent);
      expect(expectedContentJsonData).toEqual(generatedContentJsonData);
    } else {
      expect(expectedContent.replace(/\r/g, '')).toEqual(generatedContent.replace(/\r/g, ''));
    }
  });
}

const pathToPackagesApps = path.resolve('packages', 'apps');

const createTestApp = async appName => {
  const excludeFromCopy = ['.test.js', '-lock.json', 'node_modules', 'dist', '.occ'];
  const tempDir = await createTempDir({
    unsafeCleanup: true,
    // dir: path.resolve('.'),
    prefix: 'creation-tools-temp-dir'
  });
  const workDir = tempDir.path;

  // Copy the app files to a new working (temp) directory.
  const sourcePath = path.join(pathToPackagesApps, appName);
  const destPath = path.join(workDir, appName);
  await fse.ensureDir(destPath);
  await fse.copy(sourcePath, destPath, {
    filter: src => !excludeFromCopy.reduce((result, element) => result || src.includes(element), false)
  });

  return tempDir;
};

function validateImports(pathToFile, importToFind) {
  const fileContent = fse.readFileSync(path.resolve(pathToFile), 'utf-8');
  expect(fileContent).toMatch(new RegExp(`${importToFind}`));
}
module.exports = {
  validateOutputFiles,
  createTestApp,
  validateImports
};
