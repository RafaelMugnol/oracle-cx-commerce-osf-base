/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */

const ipc = require('node-ipc');
const logger = require('@oracle-cx-commerce/logger/server');
const {changeLogLevel} = require('@oracle-cx-commerce/logger/common');

/**
 * Initializes the ipc server used for communication between the controller and
 * its store_ui processes.
 */
function ipcStart() {
  // IPC_ID is passed in from the controller to establish a connection
  ipc.config.id = process.env.IPC_ID;
  ipc.config.retry = 1500;
  ipc.config.silent = true;

  ipc.serve();

  // Handle message prompting changing the log level
  ipc.server.on('LOGLEVEL', data => {
    changeLogLevel(logger, data.logLevel);
  });

  ipc.server.start();
}

/**
 * Uses an IPC connection to emit the given data to the controller's Unix Socket Server
 *
 * @param {string} socket the name of the Unix Socket emitting the message
 * @param {Object} data a JSON object with the message to be shared with the controller
 */
function emitMessage(socket, data) {
  ipc.connectTo('controller', () => {
    ipc.of.controller.emit(socket, Object.assign(data, {id: ipc.config.id}));
  });
}

module.exports = {ipcStart, emitMessage};
