/*
 ** Copyright (c) 2021 Oracle and/or its affiliates.
 */

const createTempDir = require('tmp-promise').dir;
const path = require('path');
const fse = require('fs-extra');

/**
 * Path patterns to exclude from the directory copy.
 *
 * @type       {Array} List of strings, not RegEx.
 */
const excludeFromCopy = ['.test.js', '-lock.json', 'node_modules', 'dist', '.occ'];

/**
 * Copies an application into a temporary folder.
 *
 * The new folder is intended to be used by tests that will process the app's files,
 * which could be destructive operations.
 *
 * Once the test is finished,
 * remember to call `cleanup()` to delete the temporary work directory.
 *
 * @param      {string}  appName  Name of the application to copy.
 * @param      {string}  appName  Name of the application to copy.
 * @return     {Object}  {path: "App's path", cleanup: 'Function to delete the temporary directory', baseDir: "Temporary directory's root path"}
 */
const createTestApp = async (appName, destDir) => {
  const tempDir = await createTempDir({
    unsafeCleanup: true,
    dir: path.resolve('.'),
    prefix: 'tests-temp-dir-'
  });

  // Copy the app files to a new working (temp) directory.
  const sourcePath = path.join('packages/apps', appName);
  const destPath = path.join(tempDir.path, destDir || appName);
  await fse.ensureDir(destPath);
  await fse.copy(sourcePath, destPath, {
    filter: src => !excludeFromCopy.reduce((result, element) => result || src.includes(element), false)
  });

  return {cleanup: tempDir.cleanup, path: destPath, baseDir: tempDir.path};
};

module.exports = {
  createTestApp,
  excludeFromCopy
};
