/*
 ** Copyright (c) 2021 Oracle and/or its affiliates.
 */

const {readPackageJson} = require('../../utils/read-package');

/*
  Substitute one module id for another when bundling. So, give the alias configuration:

  `
  {
    "react": "some-other-module"
  }
  `

  "some-other-module" will be substituted for "react" meaning "some-other-module" will be bundled instead of "react".
 */

const IS_RELATIVE_PATH = /^\.?\.\//;

module.exports = () => ({
  name: 'occ-alias',

  setup(build) {
    const {occ: {aliases = {}} = {}} = readPackageJson(build.initialOptions.absWorkingDir);

    const filter = new RegExp(`^${Object.keys(aliases).join('$|^')}$`);

    build.onResolve({filter}, args => {
      let pathAlias = aliases[args.path];

      if (pathAlias) {
        if (!IS_RELATIVE_PATH.test(pathAlias)) {
          /*
            require.resolve() converts a 'bare' module ids (e.g. '@oracle-cx-commerce/xxx') to an absolute path--aliases that are already relative or absolute paths should not be resolved.
           */
          pathAlias = require.resolve(pathAlias);
        } else {
          pathAlias = args.path;
        }

        return {path: pathAlias};
      }
    });
  }
});
