/*
 ** Copyright (c) 2022 Oracle and/or its affiliates.
 */

const sass = require('sass');
const path = require('path');
const {isRelativePath} = require('../utils/is-relative-path');

module.exports = (options = {}) => ({
  name: 'occ-sass-in-js',

  setup(build) {
    build.onResolve({filter: /\.scss$/}, args => {
      let resolvedPath;

      if (isRelativePath(args.path)) {
        resolvedPath = path.resolve(args.resolveDir, args.path);
      } else {
        resolvedPath = require.resolve(args.path);
      }

      return {
        path: resolvedPath,
        namespace: 'sass'
      };
    });

    build.onLoad({filter: /.*/, namespace: 'sass'}, args => {
      console.warn(args);
      const compiled = sass.compile(args.path, options);

      return {
        contents: `export default ${JSON.stringify(compiled.css.toString())};`,
        loader: 'js',
        watchFiles: [args.path]
      };
    });
  }
});
