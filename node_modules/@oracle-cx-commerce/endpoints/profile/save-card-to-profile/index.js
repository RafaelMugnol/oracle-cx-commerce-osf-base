/*
 ** Copyright (c) 2020 Oracle and/or its affiliates.
 */

import {createEndpoint, getBodyAsJson} from '@oracle-cx-commerce/endpoints/factory';
import {includeDerivedPropertiesToBillingAddress} from '@oracle-cx-commerce/endpoints/utils/transform/payments';
import {populateError} from '@oracle-cx-commerce/endpoints/utils';
import {transformSavedCardResponse} from '@oracle-cx-commerce/endpoints/utils/transform/profile';

/**
 * Endpoint adapter for the 'addCreditCard' action.
 */
export default createEndpoint('addCreditCard', {
  /**
   * Returns body for request to create new card for the profile.
   * @param payload contains details for new card
   * @returns body for request
   */
  processInput(payload) {
    const {billingAddress} = payload;
    if (billingAddress) {
      payload.billingAddress = includeDerivedPropertiesToBillingAddress(billingAddress);
    }

    return {
      body: payload
    };
  },
  /**
   * Convert the response from the endpoint invocation into an object
   * to be merged into the application state.
   * @param response the response object
   * @param state, the application state object
   * @returns partial state object to be merged with application state
   */
  async processOutput(response, state) {
    const json = await getBodyAsJson(response);

    return response.ok ? transformSavedCardResponse(state, json) : populateError(response, json);
  }
});
